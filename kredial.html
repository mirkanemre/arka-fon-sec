<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OtoFonFX | Ultra Store</title>
    
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="nav-header">
        <a href="index.html" class="back-link">❮ GERİ</a>
        <div style="font-size: 0.6rem; color: #48484a; font-weight: 600;">OTOFONFX v2.0.0</div>
    </div>

    <div class="header-area">
        <h1>OTOFONFX</h1>
        <p>Studio Marketplace</p>
    </div>

    <div class="info-bar">
        <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 10px;">
            <div style="text-align: center;">
                <small style="display: block; margin-bottom: 4px;">MEVCUT BAKİYE</small>
                <strong id="current-credit-val" style="font-family: 'Orbitron'; color: var(--primary); font-size: 1.3rem;">--</strong>
            </div>
            <div style="width: 1px; height: 30px; background: var(--border);"></div>
            <div style="text-align: center;">
                <small style="display: block; margin-bottom: 4px;">BİRİM MALİYET</small>
                <strong style="font-family: 'Orbitron'; font-size: 1.2rem;">1 <span style="font-size: 0.6rem; color: var(--text-dim);">KREDİ</span></strong>
            </div>
        </div>
        <small style="font-size: 0.6rem; opacity: 0.6;">Kredilerinizin kullanım süresi yoktur.</small>
    </div>

    <div class="package-list">
        <div class="main-card" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;" onclick="pay(10, 500)">
            <div class="kredi-detay">
                <strong>10</strong>
                <span>KREDİ PAKETİ</span>
            </div>
            <div class="fiyat-detay">
                <strong>500 ₺</strong>
                <small>50₺ / GÖRSEL</small>
            </div>
        </div>

        <div class="main-card popular" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;" onclick="pay(25, 1100)">
            <div class="popular-badge">SİSTEM ÖNERİSİ</div>
            <div class="kredi-detay">
                <strong>25</strong>
                <span>KREDİ PAKETİ</span>
            </div>
            <div class="fiyat-detay">
                <strong>1.100 ₺</strong>
                <small>44₺ / GÖRSEL</small>
            </div>
        </div>

        <div class="main-card" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;" onclick="pay(50, 2000)">
            <div class="kredi-detay">
                <strong>50</strong>
                <span>KREDİ PAKETİ</span>
            </div>
            <div class="fiyat-detay">
                <strong>2.000 ₺</strong>
                <small>40₺ / GÖRSEL</small>
            </div>
        </div>
    </div>

    <div class="footer">
        © 2026 OTOFONFX TECHNOLOGIES<br>
        v2.0.0 PREMIUM STORE
    </div>

    <div id="loader">
        <div class="loader-bar"></div>
        <p style="margin-top: 20px; font-size: 0.65rem; letter-spacing: 2px; font-weight: 800; color: var(--primary);">ÖDEME KANALI AÇILIYOR</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const _supabase = supabase.createClient("https://bhyeemsvcforqnddhoot.supabase.co", "sb_publishable_9txqLMJcZ5XSNd-DuOWRbg_kXhwlR6q");

        tg.ready(); tg.expand();
        tg.headerColor = "#000000";

        // Telegram Native Geri Butonu
        tg.BackButton.show();
        tg.BackButton.onClick(() => { window.location.href = 'index.html'; });

        // Mevcut krediyi çek
        async function loadUserCredit() {
            const userId = tg.initDataUnsafe?.user?.id || 1017604800;
            let { data } = await _supabase
                .from('galeriler')
                .select('kalan_kredi')
                .eq('chat_id', userId)
                .single();
            
            if (data) {
                document.getElementById('current-credit-val').innerText = data.kalan_kredi;
            }
        }

        // Ödeme Başlat
        function pay(miktar, fiyat) {
            tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('loader').style.display = 'flex';
            
            const userId = tg.initDataUnsafe?.user?.id || "unknown";
            const n8nUrl = `https://asininventory.com/webhook/kredi-satin-al?chat_id=${userId}&miktar=${miktar}&fiyat=${fiyat}`;
            
            // Beacon yöntemiyle webhook'u tetikle
            const img = new Image();
            img.onload = () => finish();
            img.onerror = () => finish();
            img.src = n8nUrl;
            
            // Güvenlik zaman aşımı
            setTimeout(finish, 3500);
        }

        function finish() { 
            document.getElementById('loader').style.display = 'none'; 
        }
        
        window.onload = loadUserCredit;
    </script>
</body>
</html>
